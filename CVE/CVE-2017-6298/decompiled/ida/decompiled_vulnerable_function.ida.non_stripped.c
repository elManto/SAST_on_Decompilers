int __fastcall TNEFFillMapi(TNEFStruct *TNEF, unsigned __int8 *data, unsigned int size, MAPIProps_0 *p)
{
  unsigned __int8 *v4; // r8
  __int64 v5; // r9
  unsigned __int8 *v6; // r13
  unsigned __int8 *v7; // rbp
  unsigned int v8; // ebx
  char *v9; // r14
  unsigned int v10; // er12
  int v11; // ebx
  signed int *v12; // r15
  unsigned int v13; // ecx
  unsigned int v14; // ST20_4
  _OWORD *v15; // rax
  unsigned int v16; // ecx
  __m128i v17; // xmm0
  unsigned int v18; // ecx
  bool v19; // cc
  signed __int64 v20; // rbp
  unsigned __int16 v21; // ax
  size_t v22; // rdx
  __int64 v23; // rcx
  __int64 v24; // rdx
  unsigned __int8 *v25; // rcx
  const void *v26; // rsi
  char *v27; // rcx
  __int64 v28; // rax
  char *v29; // rcx
  char v30; // dl
  signed int v31; // eax
  unsigned int v32; // eax
  __int16 v33; // ax
  __int64 v34; // rcx
  int v35; // eax
  int v36; // edx
  unsigned __int8 *v37; // ST20_8
  unsigned int v38; // ebp
  size_t v39; // rdi
  __int64 v40; // rcx
  void *v41; // rax
  unsigned __int8 *v42; // rdi
  unsigned __int64 v43; // rax
  size_t v44; // rdx
  void *v45; // rdi
  unsigned __int64 v46; // rax
  unsigned __int8 *v47; // rdi
  char *v48; // rbp
  signed int v49; // eax
  void *v50; // rax
  int v51; // edx
  void *v53; // rax
  unsigned __int8 *v54; // rdi
  unsigned int v55; // eax
  size_t v56; // rdx
  void *v57; // rdi
  unsigned __int8 *v58; // ST20_8
  __int64 v59; // r8
  __int64 v60; // r9
  unsigned int v61; // ebp
  void *v62; // rax
  char *v63; // r12
  signed __int64 v64; // rbx
  unsigned __int8 *v65; // r15
  signed __int64 v66; // rbp
  unsigned int v67; // er14
  __int64 v68; // r13
  _BYTE *v69; // rax
  signed __int64 v70; // r13
  __int64 v71; // rdi
  __int64 v72; // rdx
  unsigned __int8 *v73; // rdi
  char *v74; // rax
  __int64 v75; // r8
  __int64 v76; // r9
  __int64 v77; // rcx
  __int64 v78; // r8
  __int64 v79; // r9
  signed __int64 v80; // rcx
  signed __int64 v81; // r9
  signed __int64 v82; // r8
  signed __int64 v83; // rcx
  signed __int64 v84; // r9
  signed __int64 v85; // r8
  signed __int64 v86; // rcx
  signed __int64 v87; // rcx
  __int64 v88; // r8
  __int64 v89; // r9
  __int64 v90; // rcx
  __int64 v91; // r8
  __int64 v92; // r9
  signed __int64 sizea; // [rsp+8h] [rbp-A0h]
  TNEFStruct *TNEFa; // [rsp+10h] [rbp-98h]
  MAPIProps_0 *p_count; // [rsp+18h] [rbp-90h]
  int length; // [rsp+20h] [rbp-88h]
  size_t lengtha; // [rsp+20h] [rbp-88h]
  unsigned __int8 *lengthb; // [rsp+20h] [rbp-88h]
  unsigned int lengthc; // [rsp+20h] [rbp-88h]
  unsigned __int8 *lengthd; // [rsp+20h] [rbp-88h]
  int count; // [rsp+28h] [rbp-80h]
  unsigned int counta; // [rsp+28h] [rbp-80h]
  unsigned __int8 *countb; // [rsp+28h] [rbp-80h]
  unsigned int v104; // [rsp+48h] [rbp-60h]
  int i; // [rsp+4Ch] [rbp-5Ch]
  unsigned __int16 temp_word; // [rsp+5Ah] [rbp-4Eh]
  unsigned int temp_dword; // [rsp+5Ch] [rbp-4Ch]
  unsigned __int64 temp_ddword; // [rsp+60h] [rbp-48h]
  unsigned __int64 v109; // [rsp+68h] [rbp-40h]

  v109 = __readfsqword(0x28u);
  TNEFa = TNEF;
  v104 = size;
  p_count = p;
  sizea = size;
  if ( size <= 3uLL )
  {
    v83 = 426LL;
    goto LABEL_119;
  }
  v6 = data;
  v7 = data + 4;
  v8 = SwapDWord(data, 4);
  if ( v8 - 1 > 0x3E7 )
  {
    v84 = 1000LL;
    v85 = 430LL;
    v24 = v8;
LABEL_121:
    v11 = -1;
    __printf_chk(
      1LL,
      "ERROR: invalid alloc size %u at %s : %i, suspected corruption (exceeded %i bytes)\n",
      v24,
      "ytnef.c",
      v85,
      v84);
    return v11;
  }
  v9 = (char *)calloc((signed int)v8, 0x30uLL);
  p_count->properties = (MAPIProperty *)v9;
  if ( !v9 )
  {
    v87 = 432LL;
    goto LABEL_137;
  }
  v10 = 0;
  p_count->count = v8;
  v11 = -1;
  do
  {
    if ( v11 == -1 )
    {
      if ( sizea < (unsigned __int64)(v7 - v6 + 4) )
      {
        v80 = 438LL;
        goto LABEL_112;
      }
      v31 = SwapDWord(v7, 4);
      *((_DWORD *)v9 + 5) = v31;
      v4 = v7 + 4;
      *(_DWORD *)v9 = 0;
      *((_DWORD *)v9 + 7) = 0;
      if ( v31 < 0 )
      {
        v4 = (unsigned __int8 *)(v4 - v6 + 15);
        if ( (signed __int64)v4 >= sizea )
        {
          v80 = 447LL;
          goto LABEL_112;
        }
        *(__m128i *)(v9 + 4) = _mm_loadu_si128((const __m128i *)(v7 + 4));
        if ( sizea < (unsigned __int64)(v7 + 20 - v6 + 4) )
        {
          v80 = 451LL;
          goto LABEL_112;
        }
        v32 = SwapDWord(v7 + 20, 4);
        v4 = v7 + 24;
        if ( v32 )
        {
          v61 = v32 - 1;
          if ( v32 - 1 > 0x3E7 )
          {
            __printf_chk(
              1LL,
              "ERROR: invalid alloc size %u at %s : %i, suspected corruption (exceeded %i bytes)\n",
              v32,
              "ytnef.c",
              455LL,
              1000LL);
            return v11;
          }
          countb = v4;
          lengthc = v32;
          v62 = calloc(v32, 0x10uLL);
          *((_QWORD *)v9 + 4) = v62;
          v4 = countb;
          if ( !v62 )
          {
            __printf_chk(1LL, "Out of Memory at %s : %i\n", "ytnef.c", 457LL, countb, v5);
            return v11;
          }
          i = v10;
          *((_DWORD *)v9 + 7) = lengthc;
          v63 = v9;
          v64 = 16LL * v61;
          v65 = countb;
          lengthd = v6;
          while ( 1 )
          {
            if ( sizea < (unsigned __int64)(v65 - lengthd + 4) )
            {
              v11 = -1;
              v80 = 460LL;
              goto LABEL_112;
            }
            v66 = (signed __int64)(v65 + 4);
            v67 = SwapDWord(v65, 4);
            if ( v67 - 1 > 0x63 )
            {
              v11 = -1;
              v38 = v67;
              v81 = 100LL;
              v82 = 463LL;
              goto LABEL_114;
            }
            v68 = *((_QWORD *)v63 + 4);
            v69 = calloc(v67 + 1, 1uLL);
            v70 = v64 + v68;
            *(_QWORD *)v70 = v69;
            if ( !v69 )
            {
              v11 = -1;
              __printf_chk(1LL, "Out of Memory at %s : %i\n", "ytnef.c", 465LL, v4, v5);
              return v11;
            }
            v71 = v67;
            *(_DWORD *)(v70 + 8) = v67;
            if ( sizea < v67 + v66 - (signed __int64)lengthd )
              break;
            if ( v67 >> 1 )
            {
              v72 = 0LL;
              while ( 1 )
              {
                v69[v72] = v65[2 * v72 + 4];
                if ( (v67 >> 1) - 1 + 1LL == ++v72 )
                  break;
                v69 = *(_BYTE **)(*((_QWORD *)v63 + 4) + v64);
              }
            }
            if ( v67 & 3 )
              v71 = v67 + 4 - (v67 & 3);
            v64 -= 16LL;
            v65 = (unsigned __int8 *)(v66 + v71);
            if ( v64 == -16 )
            {
              v9 = v63;
              v4 = (unsigned __int8 *)(v66 + v71);
              v10 = i;
              v11 = -1;
              v6 = lengthd;
              goto LABEL_48;
            }
          }
          v11 = -1;
          v80 = 467LL;
          goto LABEL_112;
        }
        if ( sizea < (unsigned __int64)(v4 - v6 + 4) )
        {
          v80 = 476LL;
          goto LABEL_112;
        }
        v33 = SwapDWord(v7 + 24, 4);
        v4 = v7 + 28;
        *((_WORD *)v9 + 11) = v33;
LABEL_48:
        *(_DWORD *)v9 = 1;
      }
      v34 = (unsigned int)TNEFa->Debug;
      if ( (signed int)v34 > 2 )
      {
        v58 = v4;
        __printf_chk(1LL, "DEBUG(%i/%i):", 3LL, v34, v4, v5);
        __printf_chk(
          1LL,
          "Type id = %04x, Prop id = %04x",
          (unsigned __int16)*((_DWORD *)v9 + 5),
          (unsigned int)(*((_DWORD *)v9 + 5) >> 16),
          v59,
          v60);
        putchar(10);
        v4 = v58;
      }
      v35 = *((_DWORD *)v9 + 5);
      if ( v35 & 0x1000 )
      {
        v36 = (unsigned __int16)v35;
        LOWORD(v35) = 0;
        *((_DWORD *)v9 + 5) = (v36 - 4096) | v35;
        if ( sizea < (unsigned __int64)(v4 - v6 + 4) )
        {
          v80 = 488LL;
          goto LABEL_112;
        }
        v37 = v4;
        v38 = SwapDWord(v4, 4);
        v4 = v37 + 4;
        if ( v38 - 1 > 0x3E7 )
        {
          v81 = 1000LL;
          v82 = 493LL;
LABEL_114:
          __printf_chk(
            1LL,
            "ERROR: invalid alloc size %u at %s : %i, suspected corruption (exceeded %i bytes)\n",
            v38,
            "ytnef.c",
            v82,
            v81);
          return v11;
        }
        v39 = (signed int)v38;
        count = 0;
      }
      else
      {
        count = v11;
        v39 = 1LL;
        v38 = 1;
      }
      lengthb = v4;
      v12 = (signed int *)calloc(v39, 0x10uLL);
      *((_QWORD *)v9 + 5) = v12;
      v4 = lengthb;
      if ( !v12 )
      {
        __printf_chk(1LL, "Out of Memory at %s : %i\n", "ytnef.c", 495LL, lengthb, v5);
        return v11;
      }
      *((_DWORD *)v9 + 6) = v38;
      v11 = count;
      v7 = lengthb;
    }
    else
    {
      ++v11;
      --v10;
      v12 = (signed int *)(*((_QWORD *)v9 + 5) + 16LL * v11);
    }
    v13 = *((_DWORD *)v9 + 5);
    if ( (unsigned __int16)v13 > 0xBu )
    {
      if ( (unsigned __int16)v13 > 0x1Fu )
      {
        if ( (unsigned __int16)v13 == 72 )
        {
          v12[2] = 16;
          v14 = v13;
          v15 = calloc(0x10uLL, 1uLL);
          *(_QWORD *)v12 = v15;
          v16 = v14;
          if ( v15 )
          {
            if ( v7 - v6 + 16 <= sizea )
            {
              v17 = _mm_loadu_si128((const __m128i *)v7);
              v7 += 16;
              *v15 = v17;
              goto LABEL_13;
            }
            v83 = 587LL;
LABEL_119:
            v11 = -1;
            __printf_chk(1LL, "Corrupted file detected at %s : %i\n", "ytnef.c", v83, v4, v5);
            return v11;
          }
          v86 = 586LL;
LABEL_126:
          v11 = -1;
          __printf_chk(1LL, "Out of Memory at %s : %i\n", "ytnef.c", v86, v4, v5);
          return v11;
        }
        if ( (unsigned __int16)v13 != 258 )
        {
          if ( (unsigned __int16)v13 != 64 )
            goto LABEL_78;
          goto LABEL_63;
        }
        goto LABEL_66;
      }
      if ( (unsigned __int16)v13 >= 0x1Eu || (unsigned __int16)v13 == 13 )
      {
LABEL_66:
        v46 = v7 - v6 + 4;
        if ( v11 != -1 )
        {
LABEL_67:
          if ( sizea < v46 )
          {
            v83 = 516LL;
            goto LABEL_119;
          }
          v47 = v7;
          v48 = (char *)(v7 + 4);
          v49 = SwapDWord(v47, 4);
          v12[2] = v49;
          if ( v49 )
          {
            if ( v49 + v48 - (char *)v6 > sizea )
            {
              v83 = 522LL;
              goto LABEL_119;
            }
            if ( (unsigned int)(v49 - 1) > 0x1869F )
            {
              v84 = 100000LL;
              v85 = 523LL;
              v24 = (unsigned int)v49;
              goto LABEL_121;
            }
            if ( (unsigned __int16)*((_DWORD *)v9 + 5) == 31 )
            {
              v74 = to_utf8(v49, v48);
              *(_QWORD *)v12 = v74;
              if ( !v74 )
                return -1;
              v16 = *((_DWORD *)v9 + 5);
            }
            else
            {
              counta = *((_DWORD *)v9 + 5);
              lengtha = v49;
              v50 = calloc(v49, 1uLL);
              *(_QWORD *)v12 = v50;
              if ( !v50 )
              {
                v86 = 530LL;
                goto LABEL_126;
              }
              memcpy(v50, v48, lengtha);
              v16 = counta;
            }
            v49 = v12[2];
            v51 = v12[2] & 3;
            if ( v51 )
              v51 = 4 - v51;
          }
          else
          {
            v16 = *((_DWORD *)v9 + 5);
            *(_QWORD *)v12 = 0LL;
            v51 = 0;
          }
          v7 = (unsigned __int8 *)&v48[v51 + v49];
          goto LABEL_13;
        }
        if ( sizea >= v46 )
        {
          v73 = v7;
          v7 += 4;
          v12[2] = SwapDWord(v73, 4);
          v46 = v7 - v6 + 4;
          goto LABEL_67;
        }
        v80 = 511LL;
LABEL_112:
        __printf_chk(1LL, "Corrupted file detected at %s : %i\n", "ytnef.c", v80, v4, v5);
        return v11;
      }
      if ( (unsigned __int16)v13 != 20 )
        goto LABEL_78;
LABEL_63:
      v12[2] = 8;
      v41 = calloc(8uLL, 1uLL);
      *(_QWORD *)v12 = v41;
      if ( !v41 )
      {
        v86 = 576LL;
        goto LABEL_126;
      }
      if ( v7 - v6 + 7 >= sizea )
      {
        v83 = 577LL;
        goto LABEL_119;
      }
      v42 = v7;
      v7 += 8;
      v43 = SwapDDWord(v42, 8);
      v44 = v12[2];
      v45 = *(void **)v12;
      temp_ddword = v43;
      memcpy(v45, &temp_ddword, v44);
      v16 = *((_DWORD *)v9 + 5);
LABEL_13:
      v18 = v16 >> 16;
      v19 = v18 <= 0x49;
      if ( v18 == 73 )
        goto LABEL_29;
      goto LABEL_14;
    }
    if ( (unsigned __int16)v13 >= 0xAu )
      goto LABEL_82;
    if ( (unsigned __int16)v13 > 4u )
    {
      if ( (unsigned __int16)v13 != 5 )
      {
        if ( (unsigned __int16)v13 > 7u )
        {
LABEL_78:
          v11 = -1;
          puts("Bad file");
          return v11;
        }
LABEL_82:
        v12[2] = 4;
        v53 = calloc(4uLL, 1uLL);
        *(_QWORD *)v12 = v53;
        if ( !v53 )
        {
          v86 = 564LL;
          goto LABEL_126;
        }
        if ( v7 - v6 + 3 >= sizea )
        {
          v83 = 565LL;
          goto LABEL_119;
        }
        v54 = v7;
        v7 += 4;
        v55 = SwapDWord(v54, 4);
        v56 = v12[2];
        v57 = *(void **)v12;
        temp_dword = v55;
        memcpy(v57, &temp_dword, v56);
        v16 = *((_DWORD *)v9 + 5);
        goto LABEL_13;
      }
      goto LABEL_63;
    }
    if ( (unsigned __int16)v13 >= 3u )
      goto LABEL_82;
    if ( (unsigned __int16)v13 != 2 )
      goto LABEL_78;
    v12[2] = 2;
    *(_QWORD *)v12 = calloc(2uLL, 2uLL);
    v21 = SwapWord(v7, 2);
    v22 = v12[2];
    temp_word = v21;
    v7 += 4;
    memcpy(v6, &temp_word, v22);
    v18 = *((_DWORD *)v9 + 5) >> 16;
    v19 = v18 <= 0x49;
    if ( v18 == 73 )
      goto LABEL_29;
LABEL_14:
    if ( !v19 )
    {
      if ( v18 != 112 && v18 != 3613 )
        goto LABEL_17;
LABEL_29:
      v23 = (unsigned int)TNEFa->Debug;
      if ( (signed int)v23 > 2 )
        goto LABEL_57;
      goto LABEL_30;
    }
    if ( v18 - 55 > 1 )
      goto LABEL_17;
    v23 = (unsigned int)TNEFa->Debug;
    if ( (signed int)v23 > 2 )
    {
LABEL_57:
      __printf_chk(1LL, "DEBUG(%i/%i): %s\n", 3LL, v23, "Got a Subject", v5);
      if ( TNEFa->subject.size )
        goto LABEL_17;
      v40 = (unsigned int)TNEFa->Debug;
      if ( (signed int)v40 > 2 )
        __printf_chk(1LL, "DEBUG(%i/%i): %s\n", 3LL, v40, "Assigning a Subject", v5);
      goto LABEL_31;
    }
LABEL_30:
    if ( TNEFa->subject.size )
      goto LABEL_17;
LABEL_31:
    v24 = (unsigned int)v12[2];
    if ( (unsigned int)(v24 - 1) > 0x63 )
    {
      v84 = 100LL;
      v85 = 606LL;
      goto LABEL_121;
    }
    length = v12[2];
    v25 = (unsigned __int8 *)calloc((signed int)v24 + 1, 1uLL);
    TNEFa->subject.data = v25;
    if ( !v25 )
    {
      v87 = 608LL;
LABEL_137:
      v11 = -1;
      __printf_chk(1LL, "Out of Memory at %s : %i\n", "ytnef.c", v87, v4, v5);
      return v11;
    }
    v26 = *(const void **)v12;
    TNEFa->subject.size = length;
    v27 = (char *)memcpy(v25, v26, v12[2]);
    v28 = 0LL;
    while ( 1 )
    {
      v29 = &v27[v28];
      v30 = *v29;
      if ( *v29 == 47 || v30 == 92 || !v30 )
        *v29 = 95;
      if ( TNEFa->subject.size == (_DWORD)++v28 )
        break;
      v27 = (char *)TNEFa->subject.data;
    }
LABEL_17:
    if ( *((_DWORD *)v9 + 6) - 1 == v11 || v11 == -1 )
    {
      v9 += 48;
      v11 = -1;
    }
    ++v10;
  }
  while ( p_count->count > v10 );
  v20 = v7 - v6;
  if ( v20 < sizea )
  {
    if ( TNEFa->Debug > 0 )
    {
      puts("ERROR DURING MAPI READ");
      __printf_chk(1LL, "Read %td bytes, Expected %u bytes\n", v20, v104, v75, v76);
      __printf_chk(1LL, "%td bytes missing\n", sizea - v20, v77, v78, v79);
    }
    return -1;
  }
  v11 = 0;
  if ( v20 <= sizea )
    return v11;
  if ( TNEFa->Debug <= 0 )
    return -1;
  v11 = -1;
  puts("ERROR DURING MAPI READ");
  __printf_chk(1LL, "Read %td bytes, Expected %u bytes\n", v20, v104, v88, v89);
  __printf_chk(1LL, "%li bytes extra\n", v20 - sizea, v90, v91, v92);
  return v11;
}

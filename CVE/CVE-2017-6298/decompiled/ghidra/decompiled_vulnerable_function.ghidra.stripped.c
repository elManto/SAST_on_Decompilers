
ulong TNEFFillMapi(long param_1,long param_2,ulong param_3,uint *param_4)

{
  undefined auVar1 [16];
  char cVar2;
  void *__src;
  undefined2 uVar3;
  int iVar4;
  uint uVar5;
  undefined4 uVar6;
  undefined *puVar7;
  ulong uVar8;
  undefined4 *puVar9;
  void *__dest;
  long lVar10;
  ulong uVar11;
  uint uVar12;
  undefined8 uVar13;
  uint uVar14;
  size_t __nmemb;
  long lVar15;
  undefined *puVar16;
  undefined *__src_00;
  undefined *puVar17;
  undefined8 uVar18;
  uint uVar19;
  void **ppvVar20;
  undefined4 *puVar21;
  long in_FS_OFFSET;
  bool bVar22;
  uint local_80;
  undefined2 local_4e;
  undefined4 local_4c;
  undefined8 local_48;
  long local_40;
  
  puVar7 = (undefined *)(param_3 & 0xffffffff);
  local_40 = *(long *)(in_FS_OFFSET + 0x28);
  if (puVar7 < (undefined *)0x4) {
    uVar13 = 0x1aa;
LAB_0010386f:
    local_80 = 0xffffffff;
    __printf_chk(1,"Corrupted file detected at %s : %i\n","ytnef.c",uVar13);
  }
  else {
    uVar8 = SwapDWord(param_2,4);
    uVar11 = uVar8 & 0xffffffff;
    if ((int)uVar8 - 1U < 1000) {
      puVar21 = (undefined4 *)calloc((long)(int)(uint)uVar11,0x30);
      *(undefined4 **)(param_4 + 2) = puVar21;
      if (puVar21 == (undefined4 *)0x0) {
        uVar13 = 0x1b0;
LAB_00103992:
        local_80 = 0xffffffff;
        __printf_chk(1,"Out of Memory at %s : %i\n","ytnef.c",uVar13);
      }
      else {
        uVar19 = 0;
        *param_4 = (uint)uVar11;
        local_80 = 0xffffffff;
        puVar16 = (undefined *)(param_2 + 4);
        do {
          if (local_80 == 0xffffffff) {
            if (puVar7 < puVar16 + (4 - param_2)) {
              uVar13 = 0x1b6;
            }
            else {
              __src_00 = puVar16 + 4;
              iVar4 = SwapDWord(puVar16,4);
              puVar21[5] = iVar4;
              *puVar21 = 0;
              puVar21[7] = 0;
              if (-1 < iVar4) {
LAB_0010320b:
                if (2 < *(int *)(param_1 + 0x28c)) {
                  __printf_chk(1,"DEBUG(%i/%i):",3);
                  __printf_chk(1,"Type id = %04x, Prop id = %04x",(ulong)(ushort)puVar21[5]);
                  putchar(10);
                }
                uVar12 = puVar21[5];
                if ((uVar12 & 0x1000) == 0) {
                  __nmemb = 1;
                  iVar4 = 1;
                  puVar16 = __src_00;
                  uVar12 = local_80;
                }
                else {
                  puVar21[5] = uVar12 & 0xffff0000 | (uVar12 & 0xffff) - 0x1000;
                  if (puVar7 < __src_00 + (4 - param_2)) {
                    uVar13 = 0x1e8;
                    goto LAB_001037d9;
                  }
                  uVar8 = SwapDWord(__src_00,4);
                  uVar11 = uVar8 & 0xffffffff;
                  iVar4 = (int)uVar11;
                  if (999 < (int)uVar8 - 1U) {
                    uVar18 = 1000;
                    uVar13 = 0x1ed;
LAB_0010380b:
                    __printf_chk(1,
                                 "ERROR: invalid alloc size %u at %s : %i, suspected corruption (exceeded %i bytes)\n"
                                 ,uVar11,"ytnef.c",uVar13,uVar18);
                    goto LAB_00103495;
                  }
                  __nmemb = SEXT48(iVar4);
                  puVar16 = __src_00 + 4;
                  uVar12 = 0;
                }
                ppvVar20 = (void **)calloc(__nmemb,0x10);
                *(void ***)(puVar21 + 10) = ppvVar20;
                if (ppvVar20 != (void **)0x0) {
                  puVar21[6] = iVar4;
                  local_80 = uVar12;
                  goto LAB_00102ef3;
                }
                __printf_chk(1,"Out of Memory at %s : %i\n","ytnef.c",0x1ef);
                goto LAB_00103495;
              }
              if ((long)(__src_00 + (0xf - param_2)) < (long)puVar7) {
                    /* WARNING: Load size is inaccurate */
                auVar1 = *(undefined *)(puVar16 + 4);
                puVar21[1] = SUB164(auVar1,0);
                puVar21[2] = SUB164(auVar1 >> 0x20,0);
                puVar21[3] = SUB164(auVar1 >> 0x40,0);
                puVar21[4] = SUB164(auVar1 >> 0x60,0);
                if (puVar16 + 0x14 + (4 - param_2) <= puVar7) {
                  __src_00 = puVar16 + 0x18;
                  uVar8 = SwapDWord(SUB168(auVar1,0),puVar16 + 0x14,4);
                  iVar4 = (int)uVar8;
                  if (iVar4 == 0) {
                    if (puVar7 < __src_00 + (4 - param_2)) {
                      uVar13 = 0x1dc;
                      goto LAB_001037d9;
                    }
                    uVar3 = SwapDWord(__src_00,4);
                    *(undefined2 *)((long)puVar21 + 0x16) = uVar3;
                    __src_00 = puVar16 + 0x1c;
                  }
                  else {
                    if (999 < iVar4 - 1U) {
                      __printf_chk(1,
                                   "ERROR: invalid alloc size %u at %s : %i, suspected corruption (exceeded %i bytes)\n"
                                   ,uVar8 & 0xffffffff,"ytnef.c",0x1c7,1000);
                      goto LAB_00103495;
                    }
                    __dest = calloc(uVar8 & 0xffffffff,0x10);
                    *(void **)(puVar21 + 8) = __dest;
                    if (__dest == (void *)0x0) {
                      __printf_chk(1,"Out of Memory at %s : %i\n","ytnef.c",0x1c9);
                      goto LAB_00103495;
                    }
                    lVar10 = (ulong)(iVar4 - 1U) << 4;
                    puVar21[7] = iVar4;
                    do {
                      local_80 = 0xffffffff;
                      if (puVar7 < __src_00 + (4 - param_2)) {
                        uVar13 = 0x1cc;
                        goto LAB_001037d9;
                      }
                      uVar8 = SwapDWord(__src_00,4);
                      uVar11 = uVar8 & 0xffffffff;
                      uVar12 = (uint)uVar11;
                      if (99 < (int)uVar8 - 1U) {
                        uVar18 = 100;
                        uVar13 = 0x1cf;
                        goto LAB_0010380b;
                      }
                      lVar15 = *(long *)(puVar21 + 8);
                      __dest = calloc((ulong)(uVar12 + 1),1);
                      *(void **)(lVar15 + lVar10) = __dest;
                      if (__dest == (void *)0x0) {
                        __printf_chk(1,"Out of Memory at %s : %i\n","ytnef.c",0x1d1);
                        goto LAB_00103495;
                      }
                      *(uint *)((void **)(lVar15 + lVar10) + 1) = uVar12;
                      if ((long)puVar7 < (long)(__src_00 + 4 + (uVar11 - param_2))) {
                        uVar13 = 0x1d3;
                        goto LAB_001037d9;
                      }
                      if (uVar12 >> 1 != 0) {
                        lVar15 = 0;
                        while( true ) {
                          *(undefined *)((long)__dest + lVar15) = __src_00[lVar15 * 2 + 4];
                          lVar15 = lVar15 + 1;
                          if ((ulong)((uVar12 >> 1) - 1) + 1 == lVar15) break;
                          __dest = *(void **)(*(long *)(puVar21 + 8) + lVar10);
                        }
                      }
                      if ((uVar8 & 3) != 0) {
                        uVar11 = (ulong)((uVar12 + 4) - (uVar12 & 3));
                      }
                      lVar10 = lVar10 + -0x10;
                      __src_00 = __src_00 + 4 + uVar11;
                    } while (lVar10 != -0x10);
                  }
                  *puVar21 = 1;
                  goto LAB_0010320b;
                }
                uVar13 = 0x1c3;
              }
              else {
                uVar13 = 0x1bf;
              }
            }
LAB_001037d9:
            __printf_chk(1,"Corrupted file detected at %s : %i\n","ytnef.c",uVar13);
            goto LAB_00103495;
          }
          uVar19 = uVar19 - 1;
          ppvVar20 = (void **)((long)(int)(local_80 + 1) * 0x10 + *(long *)(puVar21 + 10));
          local_80 = local_80 + 1;
LAB_00102ef3:
          uVar12 = puVar21[5];
          uVar5 = uVar12 & 0xffff;
          if (uVar5 < 0xc) {
            if (9 < uVar5) {
LAB_001034ce:
              *(undefined4 *)(ppvVar20 + 1) = 4;
              __dest = calloc(4,1);
              *ppvVar20 = __dest;
              if (__dest == (void *)0x0) {
                uVar13 = 0x235;
                goto LAB_00103909;
              }
              if ((long)(puVar16 + (3 - param_2)) < (long)puVar7) {
                __src_00 = puVar16 + 4;
                local_4c = SwapDWord(puVar16,4);
                memcpy(*ppvVar20,&local_4c,(long)*(int *)(ppvVar20 + 1));
                uVar12 = puVar21[5];
                goto LAB_00102f64;
              }
              uVar13 = 0x236;
              goto LAB_0010386f;
            }
            if (4 < uVar5) {
              if (uVar5 == 5) goto LAB_0010332f;
              if (7 < uVar5) goto LAB_00103484;
              goto LAB_001034ce;
            }
            if (2 < uVar5) goto LAB_001034ce;
            if (uVar5 != 2) goto LAB_00103484;
            *(undefined4 *)(ppvVar20 + 1) = 2;
            __dest = calloc(2,2);
            *ppvVar20 = __dest;
            local_4e = SwapWord(puVar16,2);
            __src_00 = puVar16 + 4;
            memcpy(*ppvVar20,&local_4e,(long)*(int *)(ppvVar20 + 1));
            uVar12 = (uint)puVar21[5] >> 0x10;
            bVar22 = uVar12 == 0x49;
            if (!bVar22) goto LAB_00102f70;
LAB_00103070:
            uVar12 = *(uint *)(param_1 + 0x28c);
            if ((int)uVar12 < 3) goto LAB_00103084;
LAB_001032b0:
            __printf_chk(1,"DEBUG(%i/%i): %s\n",3,(ulong)uVar12,"Got a Subject");
            if (*(int *)(param_1 + 0x28) == 0) {
              if (2 < (int)*(uint *)(param_1 + 0x28c)) {
                __printf_chk(1,"DEBUG(%i/%i): %s\n",3,(ulong)*(uint *)(param_1 + 0x28c),
                             "Assigning a Subject");
              }
              goto LAB_00103094;
            }
          }
          else {
            if (uVar5 < 0x20) {
              if ((0x1d < uVar5) || (uVar5 == 0xd)) goto LAB_001033a0;
              if (uVar5 != 0x14) goto LAB_00103484;
LAB_0010332f:
              *(undefined4 *)(ppvVar20 + 1) = 8;
              __dest = calloc(8,1);
              *ppvVar20 = __dest;
              if (__dest == (void *)0x0) {
                uVar13 = 0x241;
                goto LAB_00103909;
              }
              if ((long)puVar7 <= (long)(puVar16 + (7 - param_2))) {
                uVar13 = 0x242;
                goto LAB_0010386f;
              }
              __src_00 = puVar16 + 8;
              local_48 = SwapDDWord(puVar16,8);
              memcpy(*ppvVar20,&local_48,(long)*(int *)(ppvVar20 + 1));
              uVar12 = puVar21[5];
            }
            else {
              if (uVar5 == 0x48) {
                *(undefined4 *)(ppvVar20 + 1) = 0x10;
                puVar9 = (undefined4 *)calloc(0x10,1);
                *(undefined4 **)ppvVar20 = puVar9;
                if (puVar9 != (undefined4 *)0x0) {
                  if ((long)(puVar16 + (0x10 - param_2)) <= (long)puVar7) {
                    /* WARNING: Load size is inaccurate */
                    auVar1 = *(undefined *)puVar16;
                    __src_00 = puVar16 + 0x10;
                    *puVar9 = SUB164(auVar1,0);
                    puVar9[1] = SUB164(auVar1 >> 0x20,0);
                    puVar9[2] = SUB164(auVar1 >> 0x40,0);
                    puVar9[3] = SUB164(auVar1 >> 0x60,0);
                    goto LAB_00102f64;
                  }
                  uVar13 = 0x24c;
                  goto LAB_0010386f;
                }
                uVar13 = 0x24b;
LAB_00103909:
                local_80 = 0xffffffff;
                __printf_chk(1,"Out of Memory at %s : %i\n","ytnef.c",uVar13);
                goto LAB_00103495;
              }
              if (uVar5 != 0x102) {
                if (uVar5 == 0x40) goto LAB_0010332f;
LAB_00103484:
                local_80 = 0xffffffff;
                puts("Bad file");
                goto LAB_00103495;
              }
LAB_001033a0:
              __src_00 = puVar16 + (4 - param_2);
              puVar17 = puVar16;
              if (local_80 == 0xffffffff) {
                if (puVar7 < __src_00) {
                  uVar13 = 0x1ff;
                  goto LAB_001037d9;
                }
                puVar17 = puVar16 + 4;
                uVar6 = SwapDWord(puVar16,4);
                *(undefined4 *)(ppvVar20 + 1) = uVar6;
                __src_00 = puVar17 + (4 - param_2);
              }
              if (puVar7 < __src_00) {
                uVar13 = 0x204;
                goto LAB_0010386f;
              }
              __src_00 = puVar17 + 4;
              uVar11 = SwapDWord(puVar17,4);
              uVar5 = (uint)uVar11;
              *(uint *)(ppvVar20 + 1) = uVar5;
              if (uVar5 == 0) {
                uVar12 = puVar21[5];
                *ppvVar20 = (void *)0x0;
                uVar14 = 0;
              }
              else {
                __nmemb = SEXT48((int)uVar5);
                if ((long)puVar7 < (long)(__src_00 + (__nmemb - param_2))) {
                  uVar13 = 0x20a;
                  goto LAB_0010386f;
                }
                if (99999 < uVar5 - 1) {
                  uVar18 = 100000;
                  uVar13 = 0x20b;
                  uVar11 = uVar11 & 0xffffffff;
                  goto LAB_001038a8;
                }
                uVar12 = puVar21[5];
                if ((short)uVar12 == 0x1f) {
                  __dest = (void *)to_utf8(__nmemb,__src_00);
                  *ppvVar20 = __dest;
                  if (__dest == (void *)0x0) goto LAB_00102fe9;
                  uVar12 = puVar21[5];
                }
                else {
                  __dest = calloc(__nmemb,1);
                  *ppvVar20 = __dest;
                  if (__dest == (void *)0x0) {
                    uVar13 = 0x212;
                    goto LAB_00103909;
                  }
                  memcpy(__dest,__src_00,__nmemb);
                }
                uVar5 = *(uint *)(ppvVar20 + 1);
                uVar14 = uVar5 & 3;
                if (uVar14 != 0) {
                  uVar14 = 4 - uVar14;
                }
              }
              __src_00 = __src_00 + (uVar5 + uVar14);
            }
LAB_00102f64:
            uVar12 = uVar12 >> 0x10;
            bVar22 = uVar12 == 0x49;
            if (bVar22) goto LAB_00103070;
LAB_00102f70:
            if (0x48 < uVar12 && !bVar22) {
              if ((uVar12 == 0x70) || (uVar12 == 0xe1d)) goto LAB_00103070;
              goto LAB_00102f8b;
            }
            if (1 < uVar12 - 0x37) goto LAB_00102f8b;
            uVar12 = *(uint *)(param_1 + 0x28c);
            if (2 < (int)uVar12) goto LAB_001032b0;
LAB_00103084:
            if (*(int *)(param_1 + 0x28) == 0) {
LAB_00103094:
              uVar12 = *(uint *)(ppvVar20 + 1);
              uVar11 = (ulong)uVar12;
              if (99 < uVar12 - 1) {
                uVar18 = 100;
                uVar13 = 0x25f;
                goto LAB_001038a8;
              }
              __dest = calloc((long)(int)(uVar12 + 1),1);
              *(void **)(param_1 + 0x20) = __dest;
              if (__dest == (void *)0x0) {
                uVar13 = 0x261;
                goto LAB_00103992;
              }
              __src = *ppvVar20;
              *(uint *)(param_1 + 0x28) = uVar12;
              __dest = memcpy(__dest,__src,(long)*(int *)(ppvVar20 + 1));
              lVar10 = 0;
              while( true ) {
                cVar2 = *(char *)((long)__dest + lVar10);
                if (((cVar2 == '/') || (cVar2 == '\\')) || (cVar2 == '\0')) {
                  *(char *)((long)__dest + lVar10) = '_';
                }
                iVar4 = (int)lVar10;
                lVar10 = lVar10 + 1;
                if (*(int *)(param_1 + 0x28) == iVar4 + 1) break;
                __dest = *(void **)(param_1 + 0x20);
              }
            }
          }
LAB_00102f8b:
          if ((puVar21[6] - 1 == local_80) || (local_80 == 0xffffffff)) {
            puVar21 = puVar21 + 0xc;
            local_80 = 0xffffffff;
          }
          uVar19 = uVar19 + 1;
          puVar16 = __src_00;
        } while (uVar19 <= *param_4 && *param_4 != uVar19);
        __src_00 = __src_00 + -param_2;
        if ((long)__src_00 < (long)puVar7) {
          if (0 < *(int *)(param_1 + 0x28c)) {
            puts("ERROR DURING MAPI READ");
            __printf_chk(1,"Read %td bytes, Expected %u bytes\n",__src_00,puVar7);
            __printf_chk(1,"%td bytes missing\n",puVar7 + -(long)__src_00);
          }
        }
        else {
          local_80 = 0;
          if ((long)__src_00 <= (long)puVar7) goto LAB_00103495;
          if (0 < *(int *)(param_1 + 0x28c)) {
            local_80 = 0xffffffff;
            puts("ERROR DURING MAPI READ");
            __printf_chk(1,"Read %td bytes, Expected %u bytes\n",__src_00,puVar7);
            __printf_chk(1,"%li bytes extra\n",__src_00 + -(long)puVar7);
            goto LAB_00103495;
          }
        }
LAB_00102fe9:
        local_80 = 0xffffffff;
      }
    }
    else {
      uVar18 = 1000;
      uVar13 = 0x1ae;
LAB_001038a8:
      local_80 = 0xffffffff;
      __printf_chk(1,
                   "ERROR: invalid alloc size %u at %s : %i, suspected corruption (exceeded %i bytes)\n"
                   ,uVar11,"ytnef.c",uVar13,uVar18);
    }
  }
LAB_00103495:
  if (local_40 != *(long *)(in_FS_OFFSET + 0x28)) {
                    /* WARNING: Subroutine does not return */
    __stack_chk_fail();
  }
  return (ulong)local_80;
}

